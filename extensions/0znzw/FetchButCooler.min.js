/**!
 * Fetch
 * @author 0znzw <meow@miyo.lol> (@link https://scratch.mit.edu/users/0znzw/)
 * @version 1.2
 * @license MIT AND LGPL-3.0
 * Do not remove this comment
 */
!function(e){if(!e.extensions.unsandboxed)throw new Error('"Fetch" must be ran unsandboxed.');const{Cast:t,BlockType:r,ArgumentType:s,vm:n}=e,{runtime:o}=n,a=(e,t)=>e<0?t:0===e?e:e||t,i=function(r){const s=Array.isArray(r),n="object"==typeof r;return e.extensions.isNitrobolt||e.extensions.isUSB?s?t.toArray(r):t.toObject(r):n?JSON.stringify(r):""},c=e=>{try{return new URL(e)}catch{return!1}},h=function(e,t){const r=t??"!#%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=e??20,n=r.length,o=[];for(let e=0;e<s;e++)o[e]=r.charAt(Math.random()*n);return o.join("")},d=e=>{const t=[];for(const r of o.targets)Object.values(r.blocks._blocks).filter((t=>t.opcode===e)).forEach((e=>{t.push(o._pushThread(e.id,r,{stackClick:!0}))}));return t},u=function(){const e={};return function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{e.base64js=t()}}((function(){return function e(t,r,s){function n(a,i){if(!r[a]){if(!t[a]){var c="function"==typeof require&&require;if(!i&&c)return c(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var d=r[a]={exports:{}};t[a][0].call(d.exports,(function(e){return n(t[a][1][e]||e)}),d,d.exports,e,t,r,s)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<s.length;a++)n(s[a]);return n}({"/":[function(e,t,r){"use strict";function s(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function n(e){return a[63&e>>18]+a[63&e>>12]+a[63&e>>6]+a[63&e]}function o(e,t,r){for(var s,o=[],a=t;a<r;a+=3)s=(16711680&e[a]<<16)+(65280&e[a+1]<<8)+(255&e[a+2]),o.push(n(s));return o.join("")}r.byteLength=function(e){var t=s(e),r=t[0],n=t[1];return 3*(r+n)/4-n},r.toByteArray=function(e){var t,r,n=s(e),o=n[0],a=n[1],h=new c(function(e,t,r){return 3*(t+r)/4-r}(0,o,a)),d=0,u=0<a?o-4:o;for(r=0;r<u;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],h[d++]=255&t>>16,h[d++]=255&t>>8,h[d++]=255&t;return 2===a&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,h[d++]=255&t),1===a&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,h[d++]=255&t>>8,h[d++]=255&t),h},r.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],i=16383,c=0,h=r-s;c<h;c+=i)n.push(o(e,c,c+i>h?h:c+i));return 1===s?(t=e[r-1],n.push(a[t>>2]+a[63&t<<4]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],n.push(a[t>>10]+a[63&t>>4]+a[63&t<<2]+"=")),n.join("")};for(var a=[],i=[],c="undefined"==typeof Uint8Array?Array:Uint8Array,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=0;d<64;++d)a[d]=h[d],i[h.charCodeAt(d)]=d;i[45]=62,i[95]=63},{}]},{},[])("/")})),e.base64js}.apply({});class l{constructor(e,t,r){this.controller=new AbortController,this.url=e,this.id=t,this.opts=r||{headers:{},body:"",method:"get",signal:this.controller.signal},this.resetStatus()}static Fetch=fetch;static Decoder=new TextDecoder;static Reader=class{constructor(e,t){this.onUpdate=t||(()=>{}),this.reader=e,this.done=!1,this.length=0,this.value=[]}async readAll(){for(;;){const{value:e,done:t}=await this.reader.read();if(t)break;this.length+=e.length,this.value.push(e),this.onUpdate(this)}this.onDone()}merge(){let e=0;const t=new Uint8Array(this.value.reduce(((e,t)=>e+t.length),0));for(;;){const r=this.value.shift();if(!r)break;t.set(r,e),e+=r.length}this.value=[t]}onDone(){this.merge(),this.done=!0,this.onUpdate(this)}};static Response=class{constructor(e,t){this.response=t,this.buffer=(e?.value||e)[0]}async uint8array(){return this.buffer}async arrayBuffer(){return this.buffer.buffer}async text(){return l.Decoder.decode(this.buffer,{stream:!0})}async json(){return await JSON.parse(await this.text())}async blob(){return new Blob([this.buffer],{type:"application/octet-stream"})}async base64(){return u.fromByteArray(this.buffer)}async hex(){return(await Array.fromAsync(this.buffer)).map((e=>e.toString(16).padStart(2,"0"))).join("")}async binary(){return(await Array.fromAsync(this.buffer)).map((e=>e.toString(0).padStart(8,"0"))).join("")}async dataurl(){return`data:${(this.response.headers.get("content-type")||"application/octet-stream").split(";")[0]};base64,${await this.base64()}`}};static sleeping=new Map;static aliveList=new Set;static sharedList=Object.create(null);static sleep(e,t){if(l.sleeping.get(e))return"";l.sleeping.set(e,t)}static extractSize(e){return(e=Object.fromEntries(e))["content-length"]?Number(e["content-length"]):e["content-range"]?Number(e["content-range"].split("/")[1]):(console.warn(e,"Does not conform to the HTTP 1.1 specification; and is missing both Content-Length and Content-Range."),0)}static done(e){d(`${E.id}_whenAnyFetchDone`).forEach((t=>t[E.FETCH_INSTANCE_ID]=e.id)),d(`${E.id}_whenFetchDone`).forEach((t=>t[E.FETCH_INSTANCE_ID]=e.id)),l.aliveList.delete(e.id);const t=l.sleeping.get(e.id);if(!t)return"";l.sleeping.delete(e.id),t(e)}resetStatus(e){this.sync=null,this.syncValue=null,this.canRead=!1,this.isDone=!1,this.inProgress=e||!1,this.size=0}done(){l.done(this),this.sync=new l.Response(this.syncValue,this.sync),this.size=this.sync.buffer.length,this.syncValue=null,this.inProgress=!1,this.isDone=!0}streamUpdate(e){e.done&&this.done()}startReader(){return this.inProgress||this.isDone?Promise.resolve(""):new Promise(((e,t)=>{this.resetStatus(!0),this.sync=l.Fetch(this.url,this.opts),this.sync.then((e=>(this.size=l.extractSize(e.headers||new Headers),this.sync=e,e.body.getReader()))).then((t=>{this.canRead=!0,e(this.syncValue=new l.Reader(t,this.streamUpdate.bind(this)))})).catch((e=>t(e)))}))}async start(){return this.inProgress||this.isDone?"":(await this.startReader(),this.syncValue.readAll())}async startAsync(){return await this.start()?await new Promise((e=>{l.sleep(this.id,(()=>e(this)))})):""}async tryRead(){if(this.isDone)return this.sync;if(!this.canRead)throw"cannot read, either the fetch has not started or reading is off.";return this.syncValue.merge(),new l.Response(this.syncValue,this.sync)}}l.Fetch=e.fetch.bind(e);const f={URL:{type:s.STRING,defaultValue:"https://extensions.turbowarp.org/hello.txt"}},p={ID:{type:s.STRING,defaultValue:"my fetch"}},y={RESTYPE:{type:s.STRING,menu:"RESTYPE",defaultValue:"text"}},g={META:{type:s.STRING,menu:"METAS",defaultValue:"status"}},T={HEADERS:{type:s.OBJECT||s.STRING,defaultValue:"{}"},HEADER:{type:s.STRING,defaultValue:""},VALUE:{type:s.STRING,defaultValue:""}},b={METHOD:{type:s.STRING,menu:"METHOD",defaultValue:"GET"}},A={BODY:{type:s.STRING,defaultValue:'{"body":true,"hahaha":"yes"}'}};class E{static exports={Fetch:l,zor:a,uid:h,runHats:d,validURL:c,Cast_toJSON:i};static id="0znzwFetch";constructor(){this.showArrayBuffer=!1,o.on("PROJECT_STOP_ALL",this.clear.bind(this)),o.on("PROJECT_START",this.clear.bind(this)),this.clear()}clear(){this.deleteAllFetchs(),l.aliveList=new Set,l.sharedList=Object.create(null),l.sleeping=new Map}static check=Symbol(`${E.id}.CheckPass`);getInfo(){return{id:E.id,name:"Fetch",blocks:[{opcode:"startAndFetch",blockType:r.COMMAND,text:"fetch [URL] id: [ID] and start",arguments:{...f,...p}},{opcode:"doFetch",blockType:r.COMMAND,text:"fetch [URL] id: [ID]",arguments:{...f,...p}},{opcode:"startFetch",blockType:r.COMMAND,text:"start fetch id: [ID] and wait [WAIT]",arguments:{...p,WAIT:{type:s.BOOLEAN}}},"---",{opcode:"deleteAllFetchs",blockType:r.COMMAND,text:"delete all fetchs"},{opcode:"deleteFetch",blockType:r.COMMAND,text:"delete fetch id: [ID]",arguments:{...p}},{opcode:"abortFetch",blockType:r.COMMAND,text:"abort fetch id: [ID]",arguments:{...p}},"---",{opcode:"inlineFetch",blockType:r.REPORTER,text:"fetch [URL] as [RESTYPE]",arguments:{...f,...y},allowDropAnywhere:!0},"---",{opcode:"whenAnyFetchDone",blockType:r.EVENT,text:"when any fetch finishes",isEdgeActivated:!1},{opcode:"whenFetchDone",blockType:r.HAT,text:"when fetch id: [ID] finishes",arguments:{...p},isEdgeActivated:!1},{opcode:"currentFetch",blockType:r.REPORTER,text:"(hat) current fetch",disableMonitor:!0},"---",{opcode:"fetchExists",blockType:r.BOOLEAN,text:"does fetch id: [ID] exist?",arguments:{...p}},{opcode:"fetchDone",blockType:r.BOOLEAN,text:"is fetch id: [ID] done?",arguments:{...p}},{opcode:"aliveFetchs",blockType:r.REPORTER,text:"running fetchs",allowDropAnywhere:!0,disableMonitor:!0},{opcode:"activeFetchs",blockType:r.REPORTER,text:"all fetchs",allowDropAnywhere:!0,disableMonitor:!0},"---",{opcode:"readFetchMeta",blockType:r.REPORTER,text:"get [META] from fetch id: [ID]",arguments:{...p,...g},allowDropAnywhere:!0},{opcode:"readFetch",blockType:r.REPORTER,text:"read fetched data id: [ID] as [RESTYPE]",arguments:{...p,...y},allowDropAnywhere:!0},"---",{opcode:"setBody",blockType:r.COMMAND,text:"set body of [ID] to [BODY]",arguments:{...p,...A}},{opcode:"setMethod",blockType:r.COMMAND,text:"set method of [ID] to [METHOD]",arguments:{...p,...b}},{opcode:"setHeaders",blockType:r.COMMAND,text:"set headers of [ID] to [HEADERS]",arguments:{...p,...T}},{opcode:"setHeader",blockType:r.COMMAND,text:"set header [HEADER] of [ID] to [VALUE]",arguments:{...p,...T}}],menus:{RESTYPE:{acceptReporters:!0,items:"_resType"},METAS:{acceptReporters:!0,items:"_metas"},METHOD:{acceptReporters:!0,items:"_methods"}}}}static FETCH_INSTANCE_ID=`${E.id}InstanceId`;_resType(e,r){const s=["text","json","base64","hex","binary","dataurl"];return this.showArrayBuffer&&s.push("arraybuffer"),(r||"")!==E.check?s:"arraybuffer"===(e=t.toString(e).toLowerCase())?"arrayBuffer":s.includes(e)?e:"text"}async _doRes(e,t){if("blob"===(t=this._resType(t,E.check)))return"";const r=new Promise((r=>{e.sync[t]().catch((t=>{console.warn("Failed fetch",e,"with error:",t),r("")})).then((e=>r(e)))}));return r?"json"===t?i(r):r:""}_metas(e,r){const s=["status","url","method","progress","final size","current size","json"];return(r||"")!==E.check?s:(e=t.toString(e).toLowerCase(),a(s.indexOf(e),0))}_methods(e,r){const s=["GET","POST","PATCH","DELETE","PUT","HEAD","OPTIONS","TRACE"];return(r||"")!==E.check?s:(e=t.toString(e).toUpperCase(),(s.includes(e)?e:"get").toLowerCase())}startAndFetch(e){return this.doFetch(e)?this.startFetch(e):""}doFetch({URL:e,ID:r}){return r=t.toString(r),l.sharedList[r]?"":(e=t.toString(e),c(e)?(l.sharedList[r]=new l(e,r,{}),!0):"")}startFetch({ID:e,WAIT:r}){return(e=l.sharedList[t.toString(e)])?(e=e.start(),t.toBoolean(r)?e:""):""}deleteAllFetchs(){const e=Object.keys(l.sharedList);for(const t of e)this.deleteFetch({ID:t})}deleteFetch({ID:e}){if(!(e=l.sharedList[t.toString(e)]))return!1;l.sleeping.delete(e.id),l.aliveList.delete(e.id),delete l.sharedList[e.id];try{e.controller.abort()}catch{}return!0}abortFetch({ID:e}){if(!(e=l.sharedList[t.toString(e)]))return!1;try{e.controller.abort()}catch{}}inlineFetch({URL:e,RESTYPE:r}){if(e=t.toString(e),!c(e))return"";const s=new l(e,h(50),{});return new Promise((e=>{s.startAsync().then((t=>{this._doRes(s,r).then(e)})).catch((t=>{console.error("Failed to fetch",s,"with error",t),e("")}))}))}whenAnyFetchDone(){return!0}whenFetchDone({ID:e},{thread:r}){return r[E.FETCH_INSTANCE_ID]===t.toString(e)||(r.status=4,!1)}fetchExists({ID:e}){return!!l.sharedList[t.toString(e)]}fetchDone({ID:e}){return!!(e=l.sharedList[t.toString(e)])&&(!e.inProgress&&e.isDone)}aliveFetchs(){return i(Array.from(l.aliveList))}activeFetchs(){return i(Object.keys(l.sharedList))}_fetchMetaToJSON(e){const t=e.response,r={length:e.buffer.length,status:t.status,ok:t.ok,statusText:t.statusText,bodyUsed:t.bodyUsed,type:t.type,url:t.url,redirected:t.redirected,headers:Object.fromEntries(t.headers||[])};return i(r)}async readFetchMeta({ID:e,META:r}){if(!(e=l.sharedList[t.toString(e)]))return"";switch(r=this._metas(r,E.check)){case 1:return e.url;case 2:return e.opts.method||"get"}const s=await new Promise((t=>{e.tryRead().catch((r=>{console.warn("Failed to read",e,"with error:",r),t("")})).then((e=>t(e)))}));if(!s)return"";switch(r){case 0:return s.response.status;case 3:return s.buffer.length/e.size*100;case 4:return e.size;case 5:return s.buffer.length;case 6:return this._fetchMetaToJSON(s);default:return""}}readFetch({ID:e,RESTYPE:r}){return(e=l.sharedList[t.toString(e)])?new Promise((t=>{e.tryRead().catch((r=>{console.warn("Failed to read",e,"with error:",r),t("")})).then((s=>{this._doRes(e,r).then(t)}))})):Promise.resolve(!1)}currentFetch(e,{thread:t}){return t[E.FETCH_INSTANCE_ID]||""}setHeaders({ID:e,HEADERS:r}){if(!(e=l.sharedList[t.toString(e)]))return"";e.opts.headers=i(r)}setHeader({ID:e,HEADER:r,VALUE:s}){if(!(e=l.sharedList[t.toString(e)]))return"";e.opts.headers[t.toString(r)]=s}setMethod({ID:e,METHOD:r}){if(!(e=l.sharedList[t.toString(e)]))return"";e.opts.method=this._methods(r,E.check)}setBody({ID:e,BODY:r}){if(!(e=l.sharedList[t.toString(e)]))return"";e.opts.body=r}}e.extensions.register(o[`ext_${E.id}`]=new E)}(Scratch);