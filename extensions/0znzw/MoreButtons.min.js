/**!
 * More Buttons
 * @author 0znzw <meow@miyo.lol> (@link https://scratch.mit.edu/users/0znzw/)
 * @version 1.0
 * @license MIT AND LGPL-3.0
 * Do not remove this comment
 * 
 * @todo Fix this entire thing :c.
 */
/**!
 * Many thanks to:
 * CST1229 (https://scratch.mit.edu/users/CST1229/) for creating the "getCurrentBlockArgs" function.
 * Bitter_130 for beta testing in packaged project.
 */
!function(t){"use strict";const e=t.vm,s=e.runtime,o=(s.renderer,t.Cast),n=t.BlockType,r=t.ArgumentType;t.extensions.register(new class{_classWrap(t){return`[class^="${t}"]`}_getSelectors(){const t=this._classWrap("sc-controls-bar"),e={};return e.greenFlag=this.isPackaged?this._classWrap("green-flag-button"):this._classWrap("green-flag_green-flag"),e.allContainer=this.isPackaged?t:this._classWrap("stage-header_stage-header-wrapper"),e.controlContainer=this.isPackaged?`${t} div:nth-child(1)`:this._classWrap("controls_controls-container"),e.resizeContainer=this.isPackaged?`${t} div:nth-child(2)`:this._classWrap("stage-header_stage-size-row"),e}constructor(){this.isPackaged=!!window?.scaffolding?.vm,this.selectors=this._getSelectors(),this.extensionId="0znzwMoreButtons",this.buttonCount=0,this.lastButton="",this.greenFlag=document.querySelector(this.selectors.greenFlag),this.allContainer=document.querySelector(this.selectors.allContainer),this.isPackaged||(this.allContainer=this.allContainer.parentElement),this.controlContainer=document.querySelector(this.selectors.controlContainer),this.resizeContainer=document.querySelector(this.selectors.resizeContainer),this.controlBar=[],this._updateButtons(),this.buttons={},this.controlBar[0].before(document.createElement("span")),this._updateButtons()}getInfo(){return{id:this.extensionId,name:"More Buttons",color1:"#5caf18",color2:"#509815",color3:"#509815",blocks:[{opcode:"btnCount",blockType:n.REPORTER,text:"button count"},{opcode:"lastBtn",blockType:n.REPORTER,text:"last button pressed"},{disableMonitor:!0,opcode:"hasBtn",blockType:n.BOOLEAN,text:"button [NAME] exists?",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"}}},{opcode:"newBtnUrl",blockType:n.COMMAND,text:"add new button named [NAME] with hover text [HOVER] and image-url [URL]",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"},HOVER:{type:r.STRING,defaultValue:"closes the tab"},URL:{type:r.STRING,defaultValue:"https://extensions.turbowarp.org/dango.png"}}},{opcode:"removeBtn",blockType:n.COMMAND,text:"remove button named [NAME]",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"}}},{opcode:"hideShowBtn",blockType:n.COMMAND,text:"[VISIBILITY] button [NAME]",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"},VISIBILITY:{type:r.STRING,menu:"visibility"}}},{opcode:"hideShowBar",blockType:n.COMMAND,text:"[VISIBILITY] [BAR_NAME] bar(s)",arguments:{BAR_NAME:{type:r.STRING,menu:"bar"},VISIBILITY:{type:r.STRING,menu:"visibility"}}},{opcode:"doAllBtn",blockType:n.COMMAND,text:"[OPT] all buttons",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"},OPT:{type:r.STRING,menu:"all"}}},{opcode:"btnClicked1",blockType:n.HAT,isEdgeActivated:!1,shouldRestartExistingThreads:!0,text:"when any button clicked"},{blockType:n.LABEL,text:"W.I.P"},{opcode:"moveBtn",blockType:n.COMMAND,text:"move button [NAME] to position [POS]",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"},POS:{type:r.NUMBER,defaultValue:1}}},{hideFromPalette:!0,opcode:"btnClicked2",blockType:n.HAT,isEdgeActivated:!1,shouldRestartExistingThreads:!0,text:"when button [NAME] clicked",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"}}},{opcode:"setBtnTo",blockType:n.COMMAND,text:"set image of button [NAME] to [SPRITE_OR_COSTUME] [ASSET_NAME]",arguments:{NAME:{type:r.STRING,defaultValue:"close tab"},SPRITE_OR_COSTUME:{type:r.STRING,menu:"to"},ASSET_NAME:{type:r.STRING,menu:"sprites_or_costumes"}}}],menus:{costumes:{acceptReporters:!0,items:"_getCostumes"},sprites_or_costumes:{acceptReporters:!0,acceptText:!0,items:"_getSpritesOrCostumes"},visibility:{acceptReporters:!0,items:["show","hide"]},all:{acceptReporters:!0,items:["remove","show","hide"]},bar:{acceptReporters:!0,items:["controls","resize","header","all"]},to:{acceptReporters:!0,items:["url","costume","sprite"]}}}}_costumes(){return e.editingTarget.getCostumes()}_getCostumeURL(t){return this._costumes().filter((e=>e.name===t))[0].asset.encodeDataURI()}_getCostumes(t){const e=this._costumes().map((t=>t.name));return 0!==e.length||t||e.push(""),e}_getSprites(){const t=[],o=s.targets,n=e.editingTarget.getName();e.editingTarget.isStage||t.unshift({text:"Stage",value:"_stage_"});for(let e=1;e<o.length;e++){const s=o[e];if(s.isOriginal){const e=s.getName();e===n?t.unshift({text:"this sprite",value:e}):t.push({text:e,value:e})}}return t.length>0?t:[{text:"",value:0}]}_getSpritesOrCostumes(){switch(function(){const t=window.ScratchBlocks;if(!t)return{};const e=t.selected;if(!e)return{};const s={};for(const t of e.inputList){for(const e of t.fieldRow)e.isCurrentlyEditable()&&(s[e.name]=e.getValue());if(!t.connection)continue;const e=t.connection.targetConnection.sourceBlock_;if(e&&e.isShadow())for(const o of e.inputList)for(const e of o.fieldRow)e.isCurrentlyEditable()&&(s[t.name]=e.getValue())}return s}().SPRITE_OR_COSTUME){case"costume":return this._getCostumes();case"sprite":return this._getSprites();case"url":return["put join block here to type."];default:return[""]}}_clamp(t,e,s){return s<=t?t:s>=e?e:s}_appendChild(t,e){e=e??this.controlBar.length-1,this.controlBar[e].after(t),this._updateButtons()}_updateButtons(){this.controlBar=Array.from(this.controlContainer.childNodes).filter((t=>"none"!==t.style.display))}_hasCostume(t){return this._getCostumes(!0).includes(t)}_doAll(t){Object.keys(this.buttons).forEach((e=>{t(e,this.buttons[e])}))}_snapshotStage(){return new Promise((e=>{t.vm.runtime.renderer.requestSnapshot((t=>{e(t)}))}))}_getSpriteWithEffects(t){const s=e.runtime.renderer.extractDrawableScreenSpace(t.drawableID).imageData;var o=document.createElement("canvas");return o.width=s.width,o.height=s.height,o.getContext("2d").putImageData(s,0,0),o.toDataURL("image/png")}_setURL(t,e){this.buttons[t].src=e}hasBtn({NAME:t}){return t=o.toString(t),void 0!==this.buttons[t]}btnCount(){return this.buttonCount}newBtnUrl(t,e){const n=o.toString(t.NAME);if(this.hasBtn({NAME:n}))return"";const r=o.toString(t.HOVER),i=o.toString(t.URL),a=document.createElement("img");a.loading="lazy",a.title=r,a.alt=r,a.draggable=!1,a.classList.add(this.greenFlag.classList[0]),a.src=i,a.setAttribute("data-sa-shared-space-order","0"),this.buttons[n]=a,this._appendChild(this.buttons[n]),a.onclick=()=>{this.lastButton=n,s.startHats(`${this.extensionId}_btnClicked1`)},this.buttonCount++}removeBtn({NAME:t}){if(t=o.toString(t),!this.hasBtn({NAME:t}))return"";this.buttons[t].remove(),this.buttons[t]=void 0,this.buttonCount--}moveBtn({NAME:t,POS:e}){let s;if(t=o.toString(t),!this.hasBtn({NAME:t}))return"";e=o.toNumber(e),e=this._clamp(1,this.controlBar.length,e)-1;const n=this.buttons[t].cloneNode(!1);this.buttons[t].remove(),this.buttons[t]=n;for(let t=0;t<this.controlBar.length;t++)s=this.controlBar[t].cloneNode(!1),this.controlBar[t].remove(),t===e&&this.controlContainer.appendChild(n),this.controlContainer.appendChild(s);this._updateButtons()}hideShowBtn({NAME:t,VISIBILITY:e}){if(t=o.toString(t),!this.hasBtn({NAME:t}))return"";const s=this.buttons[t];switch(e=o.toString(e)){case"show":s.style.display="";break;case"hide":s.style.display="none"}return""}btnClicked1(){return!0}btnClicked2({NAME:t}){return console.log(t),!1}lastBtn(){return this.lastButton}doAllBtn({NAME:t,OPT:e}){switch(e){case"show":this._doAll((t=>{this.hideShowBtn({NAME:t,VISIBILITY:"show"})}));break;case"hide":this._doAll((t=>{this.hideShowBtn({NAME:t,VISIBILITY:"hide"})}));break;case"remove":this._doAll((t=>{this.removeBtn({NAME:t})}))}}safeBtnCount(){}hideShowBar({VISIBILITY:t,BAR_NAME:e}){e=o.toString(e);const s="show"===(t=o.toString(t)).toLowerCase()?"":"none";switch(e){case"resize":this.resizeContainer.style.display=s;break;case"controls":this.controlContainer.style.display=s;break;case"header":this.allContainer.style.display=s;break;case"all":[this.resizeContainer,this.controlContainer].forEach((t=>t.style.display=s))}}async setBtnTo({NAME:t,SPRITE_OR_COSTUME:n,ASSET_NAME:r}){if(t=o.toString(t),!this.hasBtn({NAME:t}))return"";switch(n=o.toString(n)){case"costume":if(!this._getCostumes(!0).includes(r))return"";this._setURL(t,this._getCostumeURL(r));break;case"sprite":if("_stage_"===r)this._setURL(t,await this._snapshotStage());else if("_myself_"===r)this._setURL(t,this._getSpriteWithEffects(e.editingTarget));else{const e=s.getSpriteTargetByName(r);e&&this._setURL(t,this._getSpriteWithEffects(e))}break;case"url":this._setURL(t,r)}return""}})}(Scratch);