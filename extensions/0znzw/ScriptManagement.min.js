/**!
 * Script Manager
 * @author 0znzw <meow@miyo.icu> (@link https://scratch.mit.edu/users/0znzw/)
 * @author CST1229 https://scratch.mit.edu/users/CST1229/
 * @author FurryR https://github.com/FurryR/
 * @version 2.1
 * @license MIT
 * Do not remove this comment, also do not update on sharkpools gallery
 */
!function(t){"use strict";if(console.log('"Script Manager": https://surv.is-a.dev/gallery/'),!t.extensions.unsandboxed)throw new Error('"Script Manager" extension must be ran unsandboxed.');t.extensions.isPenguinMod&&console.warn("I see your using PenguinMod, please do not report any bugs that happen on here as i do not actively support PenguinMod.");const e=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o=[];class s{constructor(t){this.isLoop=!1,this.warpMode=t,this.justReported=null,this.reporting="",this.reported=null,this.waitingReporter=null,this.params=null,this.executionContext=null,this.op=null}reset(){return this.isLoop=!1,this.warpMode=!1,this.justReported=null,this.reported=null,this.waitingReporter=null,this.params=null,this.executionContext=null,this.op=null,this}reuse(t=this.warpMode){return this.reset(),this.warpMode=Boolean(t),this}static create(t){const e=o.pop();return void 0!==e?(e.warpMode=Boolean(t),e):new s(t)}static release(t){void 0!==t&&o.push(t.reset())}}const r="0znzwScriptManagement",i=t.vm,n=i.runtime,c=n.sequencer.constructor.prototype,M=c.stepThread;let a=null;function l(t,e){const o=t.getAllBlocks().filter(t=>t.type==e),s=t.getBlockById(e);return s&&o.push(s),o}c.stepThread=function(t){if(!t.dontStepJustThisOneTime)return M.call(this,t);t.dontStepJustThisOneTime=!1},i.on("EXTENSION_ADDED",p),i.on("BLOCKSINFO_UPDATE",p),p();const u={inline:{warning:["Currently in-dev","Not all features are available in the interpreter"],tooltip:["run blocks inline","to return a value use the inline return block"]},inlineReturn:{tooltip:'return block for the "inline block" block'},test_opcodesOf:{warning:"big scripts will slow this down alot",tooltip:'kind of like the "get blocks in thread" block but for the blocks in the branch'},toJSON:{tooltip:"the json of the current project"},set_myself:{tooltip:"saves the current block's json"},get_myself_id:{tooltip:"idk i forgot"},monitorThisThread:{tooltip:"assign a t-id to the current script to use later"},isThreadWithIDrunning:{tooltip:"returns weather or not the script with the t-id you specified is running"},stopThreadWithID:{tooltip:"stops the script that has the t-id you specified"},restartThreadWithID:{tooltip:"attempts to restart the script with the specified t-id"},setBlockViaID:{tooltip:"sets the block that has the id you specified to the inputted json"},getBlocksInThread:{warning:"big scripts will slow this down alot",tooltip:"lists all the blocks that are top-level in the script with t-id"},getBlockViaID:{tooltip:"gets the JSON of the block with the id you inputted"},storeInThread:{tooltip:"stores data in a thread using a key as the variable name"},getStoreInThread:{tooltip:'gets the data in the "variable" you set in the thread'},deleteScriptViaThreadID:{warning:"this can fuck up your project as it actually deletes the blocks",tooltip:"deletes the actual entire script in the project using t-id to get the script"},toggleScriptViaThreadID:{tooltip:["toggles a script to be on or off","use sparingly"]},getScriptsInSprite:{tooltip:"get the sprite that has a script with t-id you inputted and then return all the scripts in the sprite"},getOuterC:{warning:"this is constantly under development and may change in the future",tooltip:"gets the closes C-Block it can find to itself and returns its JSON"},forceRestartThreadWithID:{warning:"this can break stuff such as custom blocks if not used correctly",tooltip:"forces a script to restart based on its t-id"},skipBlocks:{warning:["this is under development and does not always do what it is supposed to do","use sparingly"],tooltip:"restarts the script and start specified number of blocks ahead of this block"},runInSprite:{warning:["big scripts can crash the project as it has to clone the blocks","custom blocks will not transfer, and neither will sprite specific stuff"],tooltip:"allows you to run blocks in other sprites"}};function T(){if(a){for(const t of Object.keys(u)){const e=u[t];let o=0;l(a,`${r}_${t}`).forEach(t=>{t.setWarningText(null),e.warning&&(Array.isArray(e.warning)?e.warning.forEach(e=>{t.setWarningText(e,`${r}_${o}`),o++}):t.setWarningText(e.warning,r)),e.tooltip&&(Array.isArray(e.tooltip)&&(e.tooltip=e.tooltip.join("\n")),t.setTooltip(e.tooltip))})}a.getAllBlocks().filter(t=>t.warning).map(t=>t.warning).forEach(t=>{t.hasClick&&t.iconGroup_.removeEventListener("mousedown",t.hasClick),t.hasClick=function(e){e.stopPropagation(),t.iconClick_(e),Object.keys(t.text_)[0].startsWith(r)&&t.bubble_.rendered_&&Array.from(t.bubble_.content_.children).forEach(t=>{t.setAttribute("fill","#DC143C")})},t.iconGroup_.addEventListener("mousedown",t.hasClick)})}}function p(){window.ScratchBlocks&&(a=ScratchBlocks.getMainWorkspace(),i.removeListener("EXTENSION_ADDED",p),i.removeListener("BLOCKSINFO_UPDATE",p),i.on("workspaceUpdate",T),i.runtime.on("BLOCK_DRAG_UPDATE",T),i.runtime.on("BLOCK_DRAG_END",T))}function N(t,e){return t.blocks._blocks[e]}function g(t,o){let s=[],r=o.blocks.getBlock(t);return null==(i=r)||null==i?[]:(Object.values(r.inputs).forEach(t=>{e("shadow",t)&&t.block===t.shadow?s=[...s,...g(t.block,o)]:(e("shadow",t)&&(s=[...s,...g(t.shadow,o)]),e("shadow",r)&&(s=[...s,...g(t.block,o)]))}),Object.values(r.fields).forEach(t=>{e("id",t)&&(s=[...s,...g(t.id,o)])}),s.push(r),s);var i}function y(t){return{blockType:"label",text:t}}let D=window.monitoredThreads||{};const h=n._convertBlockForScratchBlocks.bind(n);n._convertBlockForScratchBlocks=function(e,o){e.beInlineSM&&(e.blockType=t.BlockType.BOOLEAN,e.branchCount=1,e.outputShape=3,e.disableMonitor=!0,Array.isArray(e.text)||(e.text=[e.text]));const s=h(e,o);return e.outputShape&&(s.json.outputShape=e.outputShape),s},t.extensions.register(new class{constructor(){this.lastBlock="",this.target=void 0}getInfo(){return{id:r,name:"Script Management",color1:"#545454",color2:"#494949",menuIconURI:"data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxMzEuNSIgaGVpZ2h0PSIxMzEuNSIgdmlld0JveD0iMCwwLDEzMS41LDEzMS41Ij48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTc0LjI1LC0xMTQuMjUpIj48ZyBkYXRhLXBhcGVyLWRhdGE9InsmcXVvdDtpc1BhaW50aW5nTGF5ZXImcXVvdDs6dHJ1ZX0iIGZpbGwtcnVsZT0ibm9uemVybyIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0xNzcuNSwxODBjMCwtMzQuNTE3OCAyNy45ODIyLC02Mi41IDYyLjUsLTYyLjVjMzQuNTE3OCwwIDYyLjUsMjcuOTgyMiA2Mi41LDYyLjVjMCwzNC41MTc4IC0yNy45ODIyLDYyLjUgLTYyLjUsNjIuNWMtMzQuNTE3OCwwIC02Mi41LC0yNy45ODIyIC02Mi41LC02Mi41eiIgZmlsbD0iIzU0NTQ1NCIgc3Ryb2tlPSIjMjgyODI4IiBzdHJva2Utd2lkdGg9IjYuNSIvPjxwYXRoIGQ9Ik0xOTAuMDEzMTMsMTY0LjcxNTAxYy0wLjI5NzA0LC0yLjEzNTYyIDEuMTkzNDIsLTQuMTA3NjcgMy4zMjkwNCwtNC40MDQ3Mmw3LjczMzc2LC0xLjA3NTY4YzEuOTMzNDQsLTAuMjY4OTIgMy4wMzQ2MiwwLjU2MzMzIDQuMTM1OCwxLjM5NTZsNC40MDQ3MiwzLjMyOTA0YzEuMTAxMTgsMC44MzIyNiAyLjIwMjM2LDEuNjY0NTIgNC4xMzU4LDEuMzk1NmwxMS42MDA2NCwtMS42MTM1MmMxLjkzMzQ0LC0wLjI2ODkyIDIuNzY1NywtMS4zNzAxIDMuNTk3OTYsLTIuNDcxMjhsMy4zMjkwNCwtNC40MDQ3MmMwLjgzMjI2LC0xLjEwMTE4IDEuNjY0NTIsLTIuMjAyMzYgMy41OTc5NiwtMi40NzEyOGw0NC4zMjU5MSwtNi4xNjUyNGMyLjEzNTYyLC0wLjI5NzA0IDQuMTA3NjcsMS4xOTM0MiA0LjQwNDcyLDMuMzI5MDRsNS4zNzg0LDM4LjY2ODhjMC4yOTcwNCwyLjEzNTYyIC0xLjE5MzQyLDQuMTA3NjcgLTMuMzI5MDQsNC40MDQ3MmwtNDQuMzI1OTEsNi4xNjUyNGMtMS45MzM0NCwwLjI2ODkyIC0yLjc2NTcsMS4zNzAxIC0zLjU5Nzk2LDIuNDcxMjhsLTMuMzI5MDQsNC40MDQ3MmMtMC44MzIyNiwxLjEwMTE4IC0xLjY2NDUyLDIuMjAyMzYgLTMuNTk3OTYsMi40NzEyOGwtMTEuNjAwNjQsMS42MTM1MmMtMS45MzM0NCwwLjI2ODkyIC0zLjAzNDYyLC0wLjU2MzMzIC00LjEzNTgsLTEuMzk1NmwtNC40MDQ3MiwtMy4zMjkwNGMtMS4xMDExOCwtMC44MzIyNiAtMi4yMDIzNiwtMS42NjQ1MiAtNC4xMzU4LC0xLjM5NTZsLTcuNzMzNzYsMS4wNzU2OGMtMi4xMzU2MiwwLjI5NzA0IC00LjEwNzY3LC0xLjE5MzQyIC00LjQwNDcyLC0zLjMyOTA0eiIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjAiLz48cGF0aCBkPSJNMjc4LjM2NzY5LDE3OS4xMjZsLTEuMDk0ODQsMy4yMzk3OWMtMC4zNjczNCwxLjA4NyAtMS41NDg4NSwxLjYzODk2IC0yLjYzNTA2LDEuMjcxODlsLTEuOTE0ODIsLTAuNjQ3MDhjLTAuODIzOTgsMS4yNjUyMiAtMS44MjExOCwyLjM4NTI3IC0yLjk0NTU5LDMuMzMwMTlsMC45MDQ2NywxLjg1NDY0YzAuMjQ0OSwwLjQ5NzU2IDAuMjgzNzMsMS4wNjExMiAwLjEwNTksMS41ODczNGMtMC4xNzkxMywwLjUyNDkgLTAuNTUwMDMsMC45NTE3NSAtMS4wNDY4LDEuMTk2OTJsLTMuMDY3NiwxLjUxNjAxYy0wLjQ5Njc3LDAuMjQ1MTcgLTEuMDYxNjQsMC4yODI2OCAtMS41ODc4NSwwLjEwNDg1Yy0wLjUyNzAxLC0wLjE3ODA5IC0wLjk1MjgsLTAuNTQ5NTEgLTEuMTk5MDEsLTEuMDQ4MzhsLTAuOTQ2MTUsLTEuOTA1NDFjLTEuNDA4MjQsMC4yODgwNiAtMi44NDYzOSwwLjM5MDEzIC00LjM0ODg2LDAuMjYwNDNsLTAuNjkxNDEsMi4wNDU5OGMtMC4zNjcwNywxLjA4NjIxIC0xLjUzMDg4LDEuNjY4NjYgLTIuNjE3MSwxLjMwMTU5bC0zLjI0MjE1LC0xLjA5NTY0Yy0xLjA4NjIxLC0wLjM2NzA3IC0xLjY0NDc5LC0xLjUzMTU3IC0xLjI3NzcyLC0yLjYxNzc4bDAuNjkxMTQsLTIuMDQ1MTljLTEuMjcyMSwtMC44MDg4MSAtMi4zNjEzOCwtMS43NjQ5OCAtMy4zMDYyMSwtMi44NDgyM2wtMS45MjE2NCwwLjkzOTc5Yy0wLjQ5NzU2LDAuMjQ0OSAtMS4wNjE2NCwwLjI4MjY4IC0xLjU4NzA3LDAuMTA1MTJjLTAuNTI1NDQsLTAuMTc3NTYgLTAuOTUwNDUsLTAuNTQ4NzEgLTEuMTk3MTksLTEuMDQ2MDJsLTEuNTE4NjMsLTMuMDY3NjFjLTAuMjQ1OTUsLTAuNDk3MDQgLTAuMjgyOTQsLTEuMDYzNDcgLTAuMTA1MTEsLTEuNTg5NjljMC4xNzc4MywtMC41MjYyMiAwLjU1MDA0LC0wLjk1NDM3IDEuMDQ3ODcsLTEuMjAwMDZsMS44NDM5NiwtMC45MTk2NmMtMC4zMjEsLTEuNDMyNSAtMC40MzQ2MiwtMi45MjcwNiAtMC4zMjA5LC00LjQzNDA1bC0xLjkxNDgyLC0wLjY0NzA4Yy0xLjA4NywtMC4zNjczNCAtMS42NzU3OSwtMS41MTc1NCAtMS4zMDg0NSwtMi42MDQ1NGwxLjA5NDg0LC0zLjIzOTc5YzAuMzY2MjcsLTEuMDgzODYgMS41Mzg3MSwtMS42NjA3NSAyLjYyNTcxLC0xLjI5MzQybDEuOTE0ODIsMC42NDcwOGMwLjgyMzczLC0xLjI2NzA2IDEuODE4NzksLTIuMzc4MiAyLjk0MzcyLC0zLjMyMjA3bC0wLjkwODg5LC0xLjg0NzMyYy0wLjI0Njc0LC0wLjQ5NzMgLTAuMjgyOTUsLTEuMDYwODUgLTAuMTA1MzgsLTEuNTg2MjhjMC4xNzUxNywtMC41MTgzNyAwLjU1NjMzLC0wLjk1NDg3IDEuMDQ3ODUsLTEuMTk3NDRsMy4wNjYwMywtMS41MTY1NGMwLjk5NjQzLC0wLjQ5MTExIDIuMjk3MzMsLTAuMDUyMzcgMi43ODg3LDAuOTQzMjhsMC45NTE2MywxLjkwOTg5YzEuNDA4MjQsLTAuMjg4MDYgMi44NTQ1MSwtMC4zODgyNiA0LjM1NTkzLC0wLjI1ODA0bDAuNjkxOTQsLTIuMDQ3NTVjMC4zNjcwNywtMS4wODYyMSAxLjUyMzM3LC0xLjY5MDQ0IDIuNjA5NTgsLTEuMzIzMzdsMy4yNDIxNSwxLjA5NTY0YzEuMDg2MjEsMC4zNjcwNyAxLjY1MjMxLDEuNTUzMzYgMS4yODUyNCwyLjYzOTU3bC0wLjY5MjIxLDIuMDQ4MzNjMS4yNzMxNSwwLjgwODI4IDIuMzU0NTcsMS43NjE4MSAzLjI5ODEsMi44NDM3NGwxLjkxNTg4LC0wLjk0MDg2YzAuOTkxNzIsLTAuNDkyNyAyLjI5MTgzLC0wLjA1NDIzIDIuNzgzOTksMC45NDE2OGwxLjUxOTE2LDMuMDY2MDRjMC4yNDQ2NSwwLjQ5NTcyIDAuMjgyNjgsMS4wNjE2NCAwLjEwNTEyLDEuNTg3MDdjLTAuMTc3ODMsMC41MjYyMiAtMC41NDk1MSwwLjk1MjggLTEuMDQ2NTUsMS4xOTg3NmwtMS44NDIxLDAuOTE0MTZjMC4zMjI1NywxLjQzMzAzIDAuNDM4ODUsMi45MTk3NCAwLjMyNTkxLDQuNDI2OTlsMS45MTQwMywwLjY0NjgyYzEuMDg2MjEsMC4zNjcwNyAxLjY4MzI5LDEuNTQxOTUgMS4zMTYyMywyLjYyNTU0ek0yNjUuOTg4MDMsMTc2Ljc0Nzc5YzEuMTUxMzcsLTMuNDA3MDggLTAuNzA2MjQsLTcuMTA4MTggLTQuMTQ1NTIsLTguMjcwNDRjLTMuNDM4NSwtMS4xNjE5OSAtNy4xNTg4MiwwLjY1NDEyIC04LjMxMDIsNC4wNjEyYy0xLjE1MDU4LDMuNDA0NzMgMC43MDQxNCw3LjEwOTIyIDQuMTQyNjQsOC4yNzEyMWMzLjQzOTI4LDEuMTYyMjYgNy4xNjE0NSwtMC42NTY3MyA4LjMxMzA5LC00LjA2MTk4eiIgZmlsbD0iIzU0NTQ1NCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjAiLz48L2c+PC9nPjwvc3ZnPjwhLS1yb3RhdGlvbkNlbnRlcjo2NS43NTo2NS43NDk5OTk5OTk5OTk5Ny0tPg==",blocks:[{blockType:t.BlockType.REPORTER,opcode:"toJSON",text:"project json"},y("Threads"),{blockType:t.BlockType.COMMAND,opcode:"set_myself",text:"use this place as command basis"},{blockType:t.BlockType.REPORTER,opcode:"get_myself_id",text:"stored block sid"},{blockType:t.BlockType.COMMAND,opcode:"monitorThisThread",text:"monitor current script w/ tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.ArgumentType.BOOLEAN,opcode:"isThreadWithIDrunning",text:"is thread w/ tid: [ID] running?",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.COMMAND,opcode:"stopThreadWithID",text:"stop thread w/ tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.COMMAND,opcode:"restartThreadWithID",text:"attempt restart thread w/ tid: [ID]",arguments:{ID:{type:"string"}}},y("Blocks"),{blockType:t.BlockType.COMMAND,opcode:"setBlockViaID",text:"set block w/ sid: [ID] to json: [block]",arguments:{ID:{type:"string"},block:{type:"string",defaultValue:"{}"}}},{blockType:t.BlockType.REPORTER,opcode:"getBlocksInThread",text:"get blocks in thread w/ tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.REPORTER,opcode:"getBlockViaID",text:"get block w/ sid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.COMMAND,opcode:"storeInThread",text:"store data in thread with key [key] and value [value]",arguments:{key:{type:"string"},value:{type:"string"}}},{blockType:t.BlockType.REPORTER,opcode:"getStoreInThread",text:"get data with key [key] in thread data storage",arguments:{key:{type:"string"}}},"---",{blockType:t.BlockType.COMMAND,opcode:"deleteScriptViaThreadID",text:"delete script w/ tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.COMMAND,opcode:"toggleScriptViaThreadID",text:"toggle script w/ tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.REPORTER,opcode:"getScriptsInSprite",text:"get all scripts in sprite containing thread of tid: [ID]",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.REPORTER,opcode:"getOuterC",text:"get inner most c block relative to this block"},y("Other"),{opcode:"runInSprite",blockType:t.BlockType.CONDITIONAL,text:["run code as [SPRITE]","and dont wait [DONT_WAIT]?"],arguments:{SPRITE:{type:t.ArgumentType.STRING,menu:"targets"},DONT_WAIT:{type:t.ArgumentType.BOOLEAN}}},{opcode:"inline",text:"inline",beInlineSM:1},{opcode:"inlineReturn",blockType:t.BlockType.COMMAND,text:"inline return [value]",arguments:{value:{type:"string"}},isTerminal:!0},{opcode:"test_opcodesOf",text:"get list of opcodes",beInlineSM:1},(e="⚠ DANGEROUS OR BROKEN ⚠",o="danger",{blockType:"button",text:e,func:o}),{blockType:t.BlockType.COMMAND,opcode:"forceRestartThreadWithID",text:"force restart thread w/ tid: [ID] and update",arguments:{ID:{type:"string"}}},{blockType:t.BlockType.COMMAND,opcode:"skipBlocks",text:"restart thread and start [BLOCKS] blocks ahead",arguments:{BLOCKS:{type:"number"}}}],menus:{targets:{acceptReporters:!0,items:this._getTargets("stage")},targetsMyself:{acceptReporters:!0,items:this._getTargets("stage","myself")}}};var e,o}danger(){}_getTargets(t,e){const o=[];t&&o.push({text:"Stage",value:"_stage_"}),e&&o.push({text:"myself",value:"_myself_"});const s=n.targets;for(let t=1;t<s.length;t++){const e=s[t].getName();o.push({text:e,value:e})}return o.length>0?o:[{text:"",value:0}]}stirSoup(t){const e="!#%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=[];for(let s=0;s<t;s++)o[s]=e.charAt(87*Math.random());return o.join("")}deleteScriptViaThreadID(t,e){let o=D[t.ID].topBlock;i.runtime.quietGlow(o),e.target.blocks._deleteScript(o),delete D[t.ID]}setBlockViaID(t,e){e.target.blocks._blocks[t.ID]=JSON.parse(t.block),i.runtime.requestBlocksUpdate()}toggleScriptViaThreadID(t,e){i.runtime.toggleScript(D[t.ID].topBlock,e.target)}getBlockViaID(t,e){try{return JSON.stringify(e.target.blocks._blocks[t.ID])}catch{return'{"error":"invalid block"}'}}get_myself_id(){return this.lastBlock}set_myself(t,e){this.lastBlock=e.thread.peekStack()}monitorThisThread(t,e){D[t.ID]=e.thread}isThreadWithIDrunning(t){return i.runtime.isActiveThread(D[t.ID]||{isKilled:!0,stack:[]})}stopThreadWithID(t){try{D[t.ID].stopThisScript()}catch{}}restartThreadWithID(t){try{i.runtime._restartThread(D[t.ID])}catch{}}forceRestartThreadWithID(t,e){try{D[t.ID]=i.runtime._pushThread(D[t.ID].topBlock,e.target,{stackClick:!0})}catch{}}storeInThread(t,o){let s=o.thread;e(s,"customStorage")||(s.customStorage={}),s.customStorage[t.key]=t.value}getStoreInThread(t,o){let s=o.thread;return e(s,"customStorage")||(s.customStorage={}),e(s.customStorage,t.key)?s.customStorage[t.key]:null}getBlocksInThread(t){let e=D[t.ID],o=e.blockContainer.getBlock(e.topBlock),s=[];for(;o.next;)s.push(o.id),o.next&&(o=e.blockContainer.getBlock(o.next));return s.push(o.id),JSON.stringify(s)}getScriptsInSprite(t){return JSON.stringify(D[t.ID].blockContainer.getScripts())}getOuterC(t,e){return JSON.stringify(function(t,e){let o=N(t,e),s=!1;for(;!s&&o.hasOwnProperty("parent")&&null!==o.parent;)o=N(t,o.parent),s=o.hasOwnProperty("inputs")&&o.inputs.hasOwnProperty("SUBSTACK");return s?o:null}(e.target,e.thread.peekStack()))}toJSON(){return i.toJSON()}skipBlocks(e,o){let s=o.thread,r=s.peekStack();for(let o=0;o<=t.Cast.toNumber(e.BLOCKS)-1;o++)r=i.runtime.targets[1].blocks.getNextBlock(r);r&&(s.stopThisScript(),i.runtime._pushThread(r,o.target,{stackClick:!0}))}skipBlock_SP(e,o){for(let s=-1;s<t.Cast.toNumber(e.NUM);s++)o.thread.goToNextBlock()}spoofThread(t,o,r,i){const n={stackClick:o.stackClick??!1,updateMonitor:o.updateMonitor??!1},c=o.stackFrames[o.stackFrames.length-1].warpMode,M=new t(o.topBlock,o.target,n);M.stackFrames=[new s(c)],M.topBlock=r??M.topBlock,M.stack=[M.topBlock],M.blockGlowInFrame=M.topBlock,M.target=i??M.target,M.blockContainer=M.target.blocks;for(const t of Object.keys(o))e(M,t)||(M[t]=o[t]);return M}setGlobalStateThread(t,e){if(!t.isCompiled)return;const o=t.generator;t.generator={next:()=>{}},e.stepThread(t),t.generator=o}myId(t){return t.thread.isCompiled?t.thread.peekStack():t.thread.peekStackFrame().op.id}inline(t,o){const s=o.thread,r=s.constructor,i=o.sequencer,c=this.myId(o);if(!c)return"";const M=s.blockContainer.getBranch(c);if(!M)return"";var a=this.spoofThread(r,s,M,s.target);a.updateMonitor=!1,a.stackClick=!0;const l=n.threads.indexOf(s);n.threads.splice(l,0,a);if(new i.constructor(n).stepThread(a),this.setGlobalStateThread(s,i),s.goToNextBlock(),s.isCompiled&&a.tryCompile(),s.pushStack(M),o.thread=s,o.sequencer=i,a.dontStepJustThisOneTime=!0,a.status===r.STATUS_DONE||e(a,"inlineReturn")){const t=a.inlineReturn;return s.isCompiled||setTimeout(()=>n.visualReport(c,t),0),t??""}return new Promise(t=>{n.on("AFTER_EXECUTE",function o(){if(a.status===r.STATUS_DONE||e(a,"inlineReturn")){n.off("AFTER_EXECUTE",o);const e=a.inlineReturn;console.log(s.isCompiled),s.isCompiled||setTimeout(()=>n.visualReport(c,e),0),t(e??"")}})})}inlineReturn(t,e){const o=e.thread;o.inlineReturn=t.value,n._stopThread(o)}test_opcodesOf(t,e){const o=e.thread,s=o.blockContainer,r=s.getBranch(o.peekStack()),i=[];let n=s.getBlock(r);if(!n)return"[]";for(;null!==n.next;)i.push(n.opcode),n=s.getBlock(n.next);return n&&i.push(n.opcode),JSON.stringify(i)}until(t){const e=o=>{t()?o():n.once("AFTER_EXECUTE",t=>e(o))};return new Promise(e)}async runInSprite(e,o){let s=t.Cast.toString(e.SPRITE);const r=t.Cast.toBoolean(e.DONT_WAIT);let c;if("_stage_"===s.toLowerCase()&&(c=n._stageTarget),c||(c=n.getSpriteTargetByName(s)),!c)return 0;const M=o.thread,a=o.target,l=a.blocks,u=l.getBranch(M.peekStack(),1);let T=[],p=l.getBlock(u);for(T.push(g(p.id,a));p.next;)p.next&&(p=l.getBlock(p.next)),T.push(g(p.id,a));T[0].parent=null;for(let t=0;t<T.length;t++){const e=T[t];for(let t=0;t<e.length;t++)p=e[t],c.blocks._blocks[p.id]=p}c.blocks._addScript(u),n.requestBlocksUpdate(),i.refreshWorkspace();var N=n._pushThread(u,c,{stackClick:!0}),y=!1;return setTimeout(async()=>{await this.until(t=>1==!n.isActiveThread(N)),y=!0,c.blocks._deleteScript(N.topBlock),i.emitWorkspaceUpdate()},0),r||await this.until(t=>y),0}})}(Scratch);