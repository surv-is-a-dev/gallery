/**!
 * Try Catch
 * @author 0znzw <meow@miyo.lol> (@link https://scratch.mit.edu/users/0znzw/)
 * @version 2.8
 * @license MIT AND LGPL-3.0
 * Do not remove this comment
 * 
 * @todo Fix this in TW new compiler.
 */
!function(t){if(!t.extensions.unsandboxed)throw new Error('"Try Catch V2" extension must be ran unsandboxed.');const{BlockType:e,ArgumentType:r,vm:s}=t,n=s.runtime,a="0znzwTryCatchV2",o=s.exports??{},c=Symbol("TryCatch.Capture"),i=Symbol("TryCatch.Error");t.gui&&t.gui.getBlockly().then((t=>{if(t.registry){class e{constructor(e){this.block=e,this.altStrat=new t.dragging.BlockDragStrategy(this.block),this._updateDupe(),this.draggable=null}_updateDupe(){const t=this.block.getParent();this.shouldDuplicate=t&&t.type===`${a}_attempt`}isMovable(){return!0}startDrag(e){if(this._updateDupe(),!this.shouldDuplicate)return this.altStrat.startDrag(e);const r=this.block.toCopyData();this.draggable=t.clipboard.paste(r,this.block.workspace),this.draggable.startDrag(e)}drag(t){this.shouldDuplicate&&this.draggable?(this.block.workspace.getGesture(t).getCurrentDragger().setDraggable(this.draggable),this.draggable.drag(t)):(this.block.workspace.getGesture(t).getCurrentDragger().setDraggable(this.block),this.altStrat.drag(t))}endDrag(t){this.shouldDuplicate&&this.draggable?this.draggable.endDrag(t):this.altStrat.endDrag(t)}revertDrag(){this.shouldDuplicate&&this.draggable?(this.draggable.dispose(),this.draggable=null):this.altStrat.revertDrag()}}!function(r){const s=t.Blocks[r],n=s.init;s.init=function(...t){const r=n.apply(this,t);return this.setDragStrategy(new e(this)),r}}(`${a}_caught`)}else{const e=t.scratchBlocksUtils.isShadowArgumentReporter;t.scratchBlocksUtils.isShadowArgumentReporter=function(t){return!!e.call(this,t)||!(!t.isShadow()||t.type!=`${a}_caught`)};const r=t.BlockSvg.prototype.updateColour;t.BlockSvg.prototype.updateColour=function(...e){if(this.isShadow()&&t.scratchBlocksUtils.isShadowArgumentReporter(this)&&this.type===`${a}_caught`){const t=this.getColourTertiary;this.getColourTertiary=function(...e){const r=this.getParent();return r?r.getColourTertiary.apply(r,e):t.apply(this,e)};const e=this.isGlowingBlock_?"getColourSecondary":"getColour",r=this[e];this[e]=function(...t){const s=r.apply(this,t),n=this.getParent();return n?((t,e)=>{var r=!1;"#"==t[0]&&(t=t.slice(1),r=!0);var s=parseInt(t,16),n=(s>>16)+e;n>255?n=255:n<0&&(n=0);var a=(s>>8&255)+e;a>255?a=255:a<0&&(a=0);var o=(255&s)+e;return o>255?o=255:o<0&&(o=0),(r?"#":"")+(o|a<<8|n<<16).toString(16)})(n[e].apply(n,t),-12):s};const s=this.getOpacity;this.getOpacity=function(...t){const e=this.getParent();return e?e.getOpacity.apply(e,t):s.apply(this,t)}}return r.apply(this,e)}}}));const u=a,h=(t,e)=>{if(!t[u]){t[u]={};for(const r in e){const s=t[r];t[u][r]=t[r],t[r]=s?function(...t){return e[r].call(this,((...t)=>s.call(this,...t)),...t)}:function(...t){return e[r].call(this,(()=>{}),...t)}}}},l=n._primitives;n._primitives=new Proxy(l,{get(t,e){const r=t[e];return"function"==typeof r?function(...t){const e=t[1],{thread:s}=e;if(n=s,a=c,!Object.prototype.hasOwnProperty.call(n,a))return r(...t);var n,a;const o=s[c];try{return r(...t)}catch(t){return s[i]=t,o&&s.pushStack(o),""}}:r}});const p=`<block type="${a}_attempt"><value name="ERROR"><shadow type="${a}_caught"></shadow><block type="${a}_caught"></block></value></block>`;let g,d;const k=new function(){"use strict";this.$i=0,this.now=()=>`Perr${this.$i}`,this.next=()=>"Perr"+ ++this.$i};function y(){if(""===(this.currentFrame??""))return"('')";let t=-1,e=this.frames.findIndex((t=>t===this.currentFrame)),r=this.currentFrame;for(;r=this.frames[e-++t],void 0!==r&&!r[i];);return`(${(r||{})[i]??"''"})`}const m=o.i_will_not_ask_for_help_when_these_break;let S,b,f;if(m){const t=m();n.compilerData?((t,{IntermediateStackBlock:e,IntermediateInput:r,InputType:s,Frame:n})=>{t.registerBlock(`${a}_attempt`,(function(t,r){return new e(this.ir_opcode,{toTry:t.descendSubstack(r,"SUBSTACK"),onCaught:t.descendSubstack(r,"SUBSTACK2")})}),(function(t,e){t.source+="\ntry {\n",t.descendStack(e.inputs.toTry,new n(!1)),t.currentFrame[i]=k.next(),t.source+=`\n} catch(${t.currentFrame[i]}) {\n`,t.descendStack(e.inputs.onCaught,new n(!1)),t.source+="\n};"}),{input:!1}),t.registerBlock(`${a}_error`,(function(t,r){return new e(this.ir_opcode,{error:t.descendInputOfBlock(r,"VALUE")})}),(function(t,e){t.source+=`\nthrow new Error(${t.descendInput(e.inputs.error)});`}),{input:!1}),t.registerBlock(`${a}_caught`,(function(t,r){return new e(this.ir_opcode,this.type)}),(function(t,e){const r=y.call(t);return`(JSON.stringify({message:${r}?.message??'',name:${r}?.name??'',stack:${r}?.stack??''}))`}),{input:!0,type:s.STRING})})(n.compilerData,n.compilerData.exports):(S=t.JSGenerator,b=t.ScriptTreeGenerator,f=t.IRGenerator,({TYPE_STRING:TYPE_STRING,Frame:g,TypedInput:d}=S.unstable_exports))}else f=o?.IRGenerator,f?(S=o.JSGenerator,b=f.exports.ScriptTreeGenerator,({TYPE_UNKNOWN:TYPE_UNKNOWN,Frame:g,TypedInput:d}=S.exports)):console.error("Failed register compiler patches. VM is outdated.");if(S){const t=S.prototype,e=b.prototype;h(t,{descendStackedBlock(t,e){switch(e.kind){case`${a}.caught`:this.source+="\nvoid('');";break;case`${a}.error`:this.source+=`\nthrow new Error(${this.descendInput(e.error).asString()});`;break;case`${a}.attempt`:this.source+="\ntry {\n",this.descendStack(e.toTry,new g(!1)),this.currentFrame[i]=k.next(),this.source+=`\n} catch(${this.currentFrame[i]}) {\n`,this.descendStack(e.onCaught,new g(!1)),this.source+="\n};";break;default:return t(e)}},descendInput(t,e){if(e.kind===`${a}.caught`){const t=y.call(this);return new d(`(JSON.stringify({message:${t}?.message??'',name:${t}?.name??'',stack:${t}?.stack??''}))`,TYPE_STRING)}return t(e)}}),h(e,{descendStackedBlock(t,e){switch(e.opcode){case`${a}_caught`:return{kind:`${a}.caught`};case`${a}_error`:return{kind:`${a}.error`,error:this.descendInputOfBlock(e,"ERROR")};case`${a}_attempt`:return{kind:`${a}.attempt`,toTry:this.descendSubstack(e,"SUBSTACK"),onCaught:this.descendSubstack(e,"SUBSTACK2")};default:return t(e)}},descendInput:(t,e)=>e.opcode===`${a}_caught`?{kind:`${a}.caught`}:t(e)})}t.extensions.register(new class{getInfo(){return{id:a,name:"Try Catch V2",color1:"#ff3104",blocks:[{hideFromPalette:!0,disableMonitor:!0,opcode:"caught",text:"error",blockType:e.REPORTER,color1:"#c52300"},{hideFromPalette:!0,opcode:"attempt",text:["try","catch [ERROR]"],blockType:e.CONDITIONAL,arguments:{ERROR:{type:null}},branchCount:2},{blockType:e.XML,xml:`${p}`},{opcode:"error",text:"throw [ERROR]",blockType:e.COMMAND,arguments:{ERROR:{type:r.STRING}},isTerminal:!0}]}}async until(t){const e=r=>{t()?r():s.runtime.once("AFTER_EXECUTE",(t=>e(r)))};return new Promise(e)}caught(t,e){const r=e.thread?.[i];return r?JSON.stringify({message:r?.message??"",name:r?.name??"",stack:r?.stack??""}):'{"message":"","name":"","stack":""}'}async attempt(t,e){const{target:r,thread:s}=e,a=r.blocks,o=s.peekStack(),i=a.getBranch(o,1),u=a.getBranch(o,2)??!1;if(!i)return 0;const h=n._pushThread(i,r,{stackClick:!0,updateMonitor:!1});h[c]=u,await this.until((t=>!n.isActiveThread(h)))}error(t){throw new Error(t.ERROR)}})}(Scratch);