/**!
 * Bad Apple (Editor)
 * @author 0znzw <meow@miyo.lol> (@link https://scratch.mit.edu/users/0znzw/)
 * @version 1.4
 * @license MIT AND LGPL-3.0
 * Do not remove this comment
 */
!async function(e){"use strict";if(!e.extensions.unsandboxed)throw new Error('"Bad Apple (Editor)" must be ran unsandboxed.');const a="0znzwBadAppleEditor",t=new URLSearchParams(window.location.search),{BlockType:o,vm:s}=e,{runtime:r}=s,i=s.exports.JSZip;let n,c,l,d=16;const p=t.has("BAServer")?t.get("BAServer"):"https://miyo.lol/",u=t.has("HQAudio"),h=!1,b=`${a}_BadApple${u?"HQAudio":""}`;const g=d**2;console.log("[BadApple] Loading cache");const w=new class{constructor(e){this.dbVersion=1,e&&this.setDBName(e)}setDBName(e){return this.dbName=e,this.initializeDatabase()}initializeDatabase(){return new Promise(((e,a)=>{const t=indexedDB.open(this.dbName,this.dbVersion);t.onerror=a,t.onsuccess=a=>{this.db=a.target.result,e()},t.onupgradeneeded=e=>{this.db=e.target.result,this.db.createObjectStore("data",{keyPath:"key"})}}))}writeToDatabase(e,a){this.db.transaction(["data"],"readwrite").objectStore("data").put({key:e,value:a})}async readFromDatabase(e){return new Promise(((a,t)=>{const o=this.db.transaction(["data"],"readonly").objectStore("data").get(e);o.onsuccess=function(e){a(e.target.result?e.target.result.value:null)},o.onerror=function(e){t("Error reading from database")}}))}getAllKeys(){return new Promise(((e,a)=>{const t=this.db.transaction(["data"],"readonly").objectStore("data").getAllKeys();t.onsuccess=function(a){const t=a.target.result,o=JSON.stringify(t);e(o)},t.onerror=function(e){a("Error getting keys from database")}}))}async keyExists(e){return(await this.getAllKeys()).includes(e)}deleteFromDatabase(e){this.db.transaction(["data"],"readwrite").objectStore("data").delete(e)}};await w.setDBName(b);const B=t.has("BA_RECACHE_DANGER");if(!await w.keyExists("BadAppleCached")||B){let e=await new Promise(((e,a)=>{w.readFromDatabase("BadApple").then((async a=>{if(a&&!B)return e(a);console.log("[BadApple] Constructing cache");let t=await fetch(u?`${p}bad_apple_manifest.hq_audio.lol?v=${Date.now()}`:`${p}bad_apple_manifest.lol?v=${Date.now()}`);t=await t.text(),await w.writeToDatabase("BadApple",t),e(t)})).catch(a)}));console.log("[BadApple] Caching zip"),e=await fetch(e),e=await e.blob(),e=await i.loadAsync(e),console.log("[BadApple] Caching audio");const a=await e.files.audio.async("blob");c=await(y=a,new Promise((e=>{const a=new FileReader;a.onload=a=>e(a.target.result),a.readAsDataURL(y)}))),await w.writeToDatabase("BadAppleAudio",c.replace("application/octet-stream","audio/mp3")),console.log("[BadApple] Loading audio"),c=new Audio(URL.createObjectURL(a)),console.log("[BadApple] Loading binary data"),m=await e.files.binary.async("string"),console.log("[BadApple] Loading and decoding binary data"),l=m.replaceAll("@"," @").replaceAll("!"," !").split(" ").map((e=>e?("!"===e[0]?"0":"1").repeat(Number(e.slice(1))):"")).join(""),console.log("[BadApple] Caching binary data"),await w.writeToDatabase("BadAppleBinary",l),e=null,await w.writeToDatabase("BadAppleCached",!0)}else console.log("[BadApple] Loading cached audio"),c=new Audio(await w.readFromDatabase("BadAppleAudio")),console.log("[BadApple] Loading cached binary data"),l=await w.readFromDatabase("BadAppleBinary");var m,y;console.log("[BadApple] Ready");const A=function(e,a){const t=a??"!#%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=e??20,s=t.length,r=[];for(let e=0;e<o;e++)r[e]=t.charAt(Math.random()*s);return r.join("")};const k=r._convertBlockForScratchBlocks;r._convertBlockForScratchBlocks=function(e,a,...t){const o=k.call(this,e,a,...t);return void 0!==e.output&&(o.json.output=e.output),void 0!==e.blockShape&&(o.json.outputShape=e.blockShape),o},e.extensions.register(r[`ext_${a}`]=new class{constructor(){this.info=null,this.playing=!1,this.interval=null,this.frame=0,e.gui&&e.gui.getBlockly().then((e=>{n=e}))}static createWsBlock=(e,t)=>{const o={fields:{},id:A(),inputs:{},next:null,opcode:`${a}_bit`,parent:null,shadow:!1,topLevel:!0,x:e,y:t},r=s.editingTarget.blocks;return r._blocks[o.id]=o,r._scripts.push(o.id),o};setupBlocks(){this.blocks=new Array(g),this.wipeWS(!1);for(let e=0;e<g;e++)this.blocks[e]=this.constructor.createWsBlock(e%d*32.4,27*Math.floor(e/d)).id;s.refreshWorkspace(),console.log("[BadApple] Setup Workspace")}drawFrame(){this.frame++;const e=(this.frame-1)*g,a=l.slice(e,e+g);for(let e=0;e<g;e++){const t=n.mainWorkspace.blockDB_[this.blocks[e]],o="0"==a[e]?"#000000":"#FFFFFF";t.colour_!==o&&t.setColour(o)}}drawFrameBtn(){this.setupBlocks(),this.drawFrame()}getInfo(){return{id:a,name:"Bad Apple (Editor)",blocks:[{blockType:o.XML,xml:`<sep gap="-12" /><label text="30FPS | ${u?"16x16 HQAudio":"16x16"}" />`},{blockType:o.BUTTON,func:"drawFrameBtn",text:"draw frame"},{blockType:o.BUTTON,func:"play",text:this.playing?"Stop":"Play"},{blockType:o.REPORTER,opcode:"bit",text:"â€­",output:String(Date.now()),blockShape:3,color1:"#000000",color2:"#000000",color3:"#000000",disableMonitor:!0}]}}wipeWS(e){const a=s.editingTarget.blocks;a._blocks={},a._scripts=[],a._cache.compiledProcedures={},a._cache.compiledScripts={},a._cache.inputs={},a._cache.procedureDefinitions={},a._cache.procedureParamNames={},a._cache.proceduresPopulated={},a._cache.scripts={event_whengreaterthan:[],event_whenkeypressed:[],event_whentouchingobject:[]},a._cache._executedCached={},a._cache._monitored=null,(e??1)&&s.refreshWorkspace()}play(){this.playing=!this.playing,clearInterval(this.interval),this.wipeWS(!0),this.frame=0;const e=1e3/30;this.playing?(this.setupBlocks(),this.interval=setInterval((()=>this.drawFrame()),e),setTimeout((()=>c.play()),e)):(c.pause(),c.currentTime=0),s.extensionManager.refreshBlocks()}bit(){return""}})}(Scratch);